import 'package:celest_ast/celest_ast.dart' as ast;
import 'package:celest_cli/codegen/cloud/cloud_client_types.dart';
import 'package:celest_cli/src/types/dart_types.dart';
import 'package:celest_cli_common/celest_cli_common.dart';
import 'package:code_builder/code_builder.dart';

const kClientHeader = [
  'Generated by Celest. This file should not be modified manually, but',
  'it can be checked into version control.',
];

/// Generates the `celest` global for the backend, similar to the frontend
/// `celest` global.
final class CloudClientGenerator {
  CloudClientGenerator({
    required this.project,
  }) {
    _library = LibraryBuilder()
      ..name = ''
      ..comments.addAll(kClientHeader)
      ..body.addAll([
        _client,
        lazySpec(_clientClass.build),
      ]);
    _configLibrary = LibraryBuilder()
      ..name = ''
      ..comments.addAll(kClientHeader)
      ..body.addAll([
        _celestEnvironment,
        _variablesClass,
        _secretsClass,
      ]);
  }

  final ast.Project project;
  late final LibraryBuilder _library;
  late final LibraryBuilder _configLibrary;

  final _client = Field(
    (f) => f
      ..docs.addAll([
        '/// The interface to your Celest backend.',
        '///',
        '/// Similar to the `celest` global in the frontend, this ',
        '/// provides access to the backend environment and services',
        '/// configured for your project.',
      ])
      ..modifier = FieldModifier.constant
      ..type = CloudClientTypes.clientClass.ref
      ..name = CloudClientTypes.topLevelClient.name
      ..assignment =
          CloudClientTypes.clientClass.ref.constInstanceNamed('_', []).code,
  );

  late final _celestEnvironment = ExtensionType(
    (e) => e
      ..name = 'CelestEnvironment'
      ..constant = true
      ..primaryConstructorName = '_'
      ..representationDeclaration = RepresentationDeclaration(
        (d) => d
          ..name = '_env'
          ..declaredRepresentationType = DartTypes.core.string,
      )
      ..implements.addAll([
        DartTypes.celest.environment,
        DartTypes.core.string,
      ])
      ..docs.addAll([
        '/// An environment of a deployed Celest service.',
        '///',
        '/// Celest services can have multiple isolated branches, for example',
        '/// a `development` and `production` environment.',
      ])
      ..fields.addAll([
        Field(
          (f) => f
            ..static = true
            ..modifier = FieldModifier.constant
            ..type = refer('CelestEnvironment')
            ..name = 'local'
            ..docs.addAll([
              '/// The local Celest environment, used to delineate when a',
              '/// Celest service is running on a developer machine as opposed',
              '/// to the cloud.',
            ])
            ..assignment = refer('CelestEnvironment').constInstanceNamed('_', [
              literalString('local'),
            ]).code,
        ),
        Field(
          (f) => f
            ..static = true
            ..modifier = FieldModifier.constant
            ..type = refer('CelestEnvironment')
            ..name = 'production'
            ..docs.addAll([
              '/// The production Celest environment which is common to all',
              '/// Celest projects and labels the environment which is considered',
              '/// live and served to end-users.',
            ])
            ..assignment = refer('CelestEnvironment').constInstanceNamed('_', [
              literalString('production'),
            ]).code,
        ),
      ])
      ..methods.addAll([
        Method(
          (m) => m
            ..type = MethodType.getter
            ..returns = DartTypes.core.bool
            ..name = 'isLocal'
            ..lambda = true
            ..docs.addAll([
              '/// Whether `this` represents the [local] environment.',
            ])
            ..body = refer('this').equalTo(refer('local')).code,
        ),
        Method(
          (m) => m
            ..type = MethodType.getter
            ..returns = DartTypes.core.bool
            ..name = 'isProduction'
            ..lambda = true
            ..docs.addAll([
              '/// Whether `this` represents the [production] environment.',
            ])
            ..body = refer('this').equalTo(refer('production')).code,
        ),
      ]),
  );

  late final _clientClass = ClassBuilder()
    ..name = CloudClientTypes.clientClass.name
    ..docs.addAll([
      '/// The interface to your Celest backend.',
      '///',
      '/// Similar to the `Celest` class in the frontend, this class',
      '/// provides access to the backend environment and services',
      '/// configured for your project.',
    ])
    ..constructors.add(
      Constructor(
        (c) => c
          ..constant = true
          ..name = '_',
      ),
    )
    ..methods.addAll([
      Method(
        (m) => m
          ..returns = CloudClientTypes.environmentClass.ref
          ..type = MethodType.getter
          ..name = 'currentEnvironment'
          ..lambda = true
          ..docs.addAll([
            '/// The current environment of the Celest service.',
            '///',
            '/// This is determined by the `CELEST_ENVIRONMENT` variable',
            '/// which is set for you by the deployment environment.',
          ])
          ..body = refer('variables')
              .property('currentEnvironment')
              .asA(CloudClientTypes.environmentClass.ref)
              .code,
      ),
      Method(
        (m) => m
          ..returns = CloudClientTypes.variablesClass.ref
          ..type = MethodType.getter
          ..name = 'variables'
          ..lambda = true
          ..docs.addAll([
            '/// The variables of the Celest service.',
            '///',
            '/// This class provides access to the values configured for the',
            '/// [currentEnvironment].',
          ])
          ..body = CloudClientTypes.variablesClass.ref.constInstance([]).code,
      ),
      Method(
        (m) => m
          ..returns = CloudClientTypes.secretsClass.ref
          ..type = MethodType.getter
          ..name = 'secrets'
          ..lambda = true
          ..docs.addAll([
            '/// The secrets for the Celest service.',
            '///',
            '/// This class provides access to the secret values that are configured',
            '/// for the [currentEnvironment].',
          ])
          ..body = CloudClientTypes.secretsClass.ref.constInstance([]).code,
      ),
    ]);

  late final _variablesClass = Class((b) {
    b
      ..name = CloudClientTypes.variablesClass.name
      ..docs.addAll([
        '/// The environment variables for the Celest service.',
        '///',
        '/// This class provides access to the environment variable values',
        '/// that are configured for the current [CelestEnvironment].',
      ])
      ..constructors.add(
        Constructor(
          (c) => c..constant = true,
        ),
      )
      ..methods.addAll([
        Method((m) {
          m
            ..type = MethodType.getter
            ..returns = DartTypes.core.string
            ..name = 'currentEnvironment'
            ..docs.addAll([
              '/// The environment variable that determines the current environment.',
              '///',
              '/// This is set by the deployment environment and is used to',
              '/// determine the current environment of the Celest service.',
            ])
            ..body = DartTypes.celest.globalContext.property('expect').call([
              DartTypes.celest.environmentVariable.property('environment'),
            ]).code;
        }),
        for (final envVar in project.variables)
          Method((m) {
            m
              ..type = MethodType.getter
              ..returns = DartTypes.core.string
              ..name = envVar.dartName ?? envVar.name.camelCase
              ..docs.addAll(
                envVar.docs.isNotEmpty
                    ? envVar.docs
                    : [
                        '/// The value of the `${envVar.name}` environment variable.',
                      ],
              )
              ..body = DartTypes.celest.globalContext.property('expect').call([
                DartTypes.celest.environmentVariable.constInstance([
                  literalString(envVar.name, raw: envVar.name.contains(r'$')),
                ]),
              ]).code;
          }),
      ]);
  });

  late final _secretsClass = Class((b) {
    b
      ..name = CloudClientTypes.secretsClass.name
      ..docs.addAll([
        '/// The secrets for the Celest service.',
        '///',
        '/// This class provides access to the secret values that are configured',
        '/// for the current [CelestEnvironment].',
      ])
      ..constructors.add(
        Constructor(
          (c) => c..constant = true,
        ),
      )
      ..methods.addAll([
        for (final secret in project.secrets)
          Method((m) {
            m
              ..type = MethodType.getter
              ..returns = DartTypes.core.string
              ..name = secret.dartName ?? secret.name.camelCase
              ..docs.addAll(
                secret.docs.isNotEmpty
                    ? secret.docs
                    : ['/// The value of the `${secret.name}` secret.'],
              )
              ..body = DartTypes.celest.globalContext.property('expect').call([
                DartTypes.celest.environmentVariable.constInstance([
                  literalString(secret.name, raw: secret.name.contains(r'$')),
                ]),
              ]).code;
          }),
      ]);
  });

  Map<Uri, Library> generate() {
    final libraries = <Uri, Library>{};
    libraries[CloudPaths.client] = _library.build();
    libraries[CloudPaths.config] = _configLibrary.build();
    return libraries;
  }
}
